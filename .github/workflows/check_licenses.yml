name: Check and update licenses

on:
  push:
    branches: [ "*-software.eessi.io" ]
  pull_request:
    branches:  [ "*-software.eessi.io" ]
      #    types: [opened, synchronized]
permissions:
  contents: read # we dont need to write

jobs:
  license_update:
    runs-on: ubuntu-latest

    steps:
      -  uses: actions/checkout@v4
      -  uses: eessi/github-action-eessi@v3

      - name: If an EasyStack has been modified, create a mini EasyStack file to parse
        run: |
          git fetch https://github.com/${{ github.repository }} ${{ github.base_ref }}
          FILES=$(git diff --name-only FETCH_HEAD HEAD | grep -E 'easystacks/.*/eessi-.*\.yml') 
       
          echo "$FILES" | while read -r FILE; do
            echo "Diff for $FILE:"
            git diff --unified=0 --no-color FETCH_HEAD HEAD -- "$FILE" | grep '^+' | grep -v '^+++' >> new.added_lines.yml
          done

      - name: Parse this EasyStack 
        run: | 
          cat new.added_lines.yml
          module load EasyBuild 
          if [ -s new.added_lines.yml ]; then
            echo "Parsing the EasyStack file..."
            python licenses/parse_easystack.py new.added_lines.yml
          else
            echo "No changes detected in the EasyStack file."
          fi

