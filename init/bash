# Allow for a silent mode
if [[ -v EESSI_SILENT ]]; then
  # EESSI_SILENT set
  output=/dev/null
else
  output=/dev/stdout
fi

# The following method should be safe, but might break if file is a symlink
# (could switch to $(dirname "$(readlink -f "$BASH_SOURCE")") in that case)
source $(dirname "$BASH_SOURCE")/eessi_environment_variables

# only continue if setting EESSI environment variables worked fine
if [ $? -eq 0 ]; then

    export PS1="[EESSI pilot $EESSI_PILOT_VERSION] $ "

    # add location of commands provided by compat layer to $PATH;
    # see https://github.com/EESSI/software-layer/issues/52
    export PATH=$EPREFIX/usr/bin:$EPREFIX/bin:$PATH

    # used for EESSI specific SitePackage.lua, hide GPU modules if CUDA is not installed
    # TODO: better place to store SitePackage file?
    # TODO: another method to define path to lua file?
    export LMOD_PACKAGE_PATH=$(dirname "$BASH_SOURCE")

    # init Lmod
    echo "Initializing Lmod..." >> $output
    source $EESSI_EPREFIX/usr/share/Lmod/init/bash

    # prepend location of modules for EESSI software stack to $MODULEPATH
    echo "Prepending $EESSI_MODULEPATH to \$MODULEPATH..." >> $output
    module use $EESSI_MODULEPATH
    if [[ ! -z "${EESSI_SITE_MODULEPATH}" ]]; then
      echo "Add ${EESSI_SITE_MODULEPATH} to \$MODULEPATH for GPU support..."
      module use ${EESSI_SITE_MODULEPATH}
    fi

    #echo >> $output
    #echo "*** Known problems in the ${EESSI_PILOT_VERSION} pilot software stack ***" >> $output
    #echo >> $output
    #echo "1) ..." >> $output
    #echo >> $output
    #echo >> $output

    echo "Environment set up to use EESSI pilot software stack, have fun!" >> $output

fi
